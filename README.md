# Puppetboard Docker deployment

This repository contains the required configuration and scripts for running a Docker-based [Puppetboard](https://github.com/voxpupuli/puppetboard) service. It is not used to build the images used by the service.

Running Puppetboard only makes sense in an environment with a PuppetDB instance, so this can only be tested locally when such a service is reachable. The default configuration will attempt to connect to `puppet.ukcod.org.uk`, which is not exposed to the public internet, so testing will need to take place on a server instance within our network or when attached to our VPN.

This deployment repository uses the [Scripts to rule them all](https://github.com/github/scripts-to-rule-them-all) pattern in an attempt to be as portable as possible.

## Overview

The `docker-compose.yml` file includes two services, an Nginx reverse-proxy using the [`mysocietyorg/nginx`](https://cloud.docker.com/u/mysocietyorg/repository/docker/mysocietyorg/nginx) image and the Puppetboard service itself using the [`sagepe/puppetboard`](https://cloud.docker.com/u/sagepe/repository/docker/sagepe/puppetboard) image.

The Nginx container is configured to use HTTP Authentication and expects an appropriate `htpasswd` formatted file to be bind-mounted to `/etc/nginx/htpasswd`. The Nginx container listens on the port specified by the `PORT` environment variable (default: `8120`). The service can be suspended by placing a file called `down.html` into a directory bind-mounted to `/var/www/html`. There is a suitable configuration file at `conf/nginx.conf` that will be bind-mounted over the `default` site definition in the container.

The Puppetboard container does not expose a port, but is only accessible from the internal network. It expects the SSL certificates and keys required to access PuppetDB to be bind-mounted into `/etc/puppetlabs/puppetdb/ssl`. The compose file sets the `PUPPETDB_HOST` and `PUPPETDB_PORT` variables for mySociety's infrastructure.

## Setup

`script/bootstrap` will do the following:

* Check for Docker.
* Create a `ssl/` directory and attempt to populate this with a CA certificate and a client key and certificate. The default location for these is based on our server infrastructure so if you are running this locally you will need to ensure you have pre-seeded this location with the correct files, `ssl/ca.crt`, `ssl/puppetboard.crt` and `ssl/puppetboard.key`, or exported `CA_CERT`, `SSL_CERT` and `SSL_KEY` to locally accessible paths before running `bootstrap` for the first time.
* Create a docroot directory at `web/`. This is bind-mounted into the nginx container and should usually be empty. Placing a `down.html` file in here will disable the stack.
* Create a mock authorisation file in `conf/htpasswd`. This will configure a user, `admin`, with a random password (this will be printed to `STDOUT` when created). This will be used if the `HTPASSWD` environment variable is not set when the environment is started.
* Ensure any required images have been pulled from the Docker Hub based on the `docker-compose.yml` file.

## Deployment

Aside from the hard dependency on an accessible PuppetDB instance and the relevant certificates and keys, this repository should have everything required to run an instance of this service.

`script/server` script will attempt to start the service. It will call `script/update` which in turn will call `script/bootstrap`.

### Swarm vs. Compose

If run on a host with Swarm mode enabled, the service will be started with the `docker stack` command, otherwise `docker-compose` will be used.

In Swarm mode, this repository will need to be cloned and bootstrapped in a common location on all worker nodes. In our Production environment, this should be taken care of by Puppet. The service can then be started from a master node - `script/server` will not run on a worker node.

The default environment variables should be adequate when running locally for development using Compose mode or even a single-node Swarm, but for a multi-node Swarm they will need setting to appropriate values.

### Environment variables

The following environment variables can be set to modify the service:

* `STACK_NAME` will be used when starting in Swarm mode and defaults to `puppetboard_mysociety_org`.
* `HTPASSWD` should be a full path to an appropriate htpasswd file. When deploying to a multi-node Swarm, this path must be accessible on all worker nodes. This defaults to `.conf/htpasswd` which will contain the random password generated by the `bootstrap` script.
* `DEPLOY_PATH` should be the full path to repository working copy on Swarm worker nodes - these will need a bootstrapped copy of this repository so that bind-mounts work as expected if a container is started locally. This defaults too `.` which is suitable for local testing.
* `PORT` is the port exposed by the Nginx container. This defaults to `8120`. Note that when running in Compose mode, this port will only be accessible on the local loopback interface but when running in Swarm mode it will be available on all interfaces.
